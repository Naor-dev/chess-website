name: Plan Review

on:
  push:
    branches:
      - 'plan/**'
      - 'plan/*'
  pull_request:
    paths:
      - '**/*.plan.md'
      - '**/plan-*.md'
      - 'dev/active/**/plan.md'
      - 'dev/active/**/*-plan.md'

jobs:
  find-plans:
    runs-on: ubuntu-latest
    outputs:
      has_plans: ${{ steps.find-plans.outputs.has_plans }}
      plans: ${{ steps.find-plans.outputs.plans }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find plan files
        id: find-plans
        run: |
          echo "::group::Finding plan files"
          echo "[$(date -u +%H:%M:%S)] Event: ${{ github.event_name }}, Branch: ${{ github.head_ref || github.ref_name }}"

          # Find plan files that were changed (regex matches both file.plan.md and file-plan.md)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "[$(date -u +%H:%M:%S)] Diffing ${{ github.event.pull_request.base.sha }}..${{ github.sha }}"
            ALL_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
            echo "[$(date -u +%H:%M:%S)] All changed files:"
            echo "$ALL_CHANGED"
            CHANGED_FILES=$(echo "$ALL_CHANGED" | grep -E '(-plan\.md|\.plan\.md|plan-.*\.md)$' || true)
          else
            ALL_CHANGED=$(git diff --name-only HEAD~1 HEAD)
            echo "[$(date -u +%H:%M:%S)] All changed files:"
            echo "$ALL_CHANGED"
            CHANGED_FILES=$(echo "$ALL_CHANGED" | grep -E '(-plan\.md|\.plan\.md|plan-.*\.md)$' || true)
          fi

          echo "[$(date -u +%H:%M:%S)] Plan files from diff: ${CHANGED_FILES:-none}"

          # Fallback: check dev/active for plan files (only *-plan.md, not context/tasks)
          if [ -z "$CHANGED_FILES" ]; then
            echo "[$(date -u +%H:%M:%S)] No plan files in diff, scanning dev/active/"
            ACTIVE_PLANS=$(find dev/active -name "*-plan.md" -o -name "*.plan.md" 2>/dev/null | head -5 || true)
            echo "[$(date -u +%H:%M:%S)] Active plans found: ${ACTIVE_PLANS:-none}"
          else
            ACTIVE_PLANS=""
          fi

          # Combine and dedupe
          ALL_PLANS=$(echo -e "${CHANGED_FILES}\n${ACTIVE_PLANS}" | sort -u | grep -v '^$' | head -5)

          if [ -z "$ALL_PLANS" ]; then
            echo "[$(date -u +%H:%M:%S)] No plan files found"
            echo "has_plans=false" >> $GITHUB_OUTPUT
          else
            PLAN_COUNT=$(echo "$ALL_PLANS" | wc -l)
            echo "[$(date -u +%H:%M:%S)] Found $PLAN_COUNT plan(s):"
            echo "$ALL_PLANS" | while read -r f; do
              SIZE=$(wc -c < "$f" 2>/dev/null || echo "?")
              LINES=$(wc -l < "$f" 2>/dev/null || echo "?")
              echo "  - $f ($LINES lines, $SIZE bytes)"
            done
            echo "plans<<EOF" >> $GITHUB_OUTPUT
            echo "$ALL_PLANS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_plans=true" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

  review-plan-claude:
    needs: find-plans
    if: needs.find-plans.outputs.has_plans == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        model: [opus, sonnet]
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Review plans with Claude Code (${{ matrix.model }})
        id: review
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          MODEL="${{ matrix.model }}"
          REVIEW_OUTPUT="/tmp/plan-review-${MODEL}.md"
          ERROR_LOG="/tmp/claude-error.log"

          echo "::group::Setup"
          echo "[$(date -u +%H:%M:%S)] Model: $MODEL"
          echo "[$(date -u +%H:%M:%S)] Claude Code version: $(claude --version 2>/dev/null || echo 'unknown')"
          echo "[$(date -u +%H:%M:%S)] OAuth token set: $([ -n \"$CLAUDE_CODE_OAUTH_TOKEN\" ] && echo 'yes' || echo 'NO - MISSING!')"
          echo "::endgroup::"

          echo "# Claude Plan Review (${MODEL^^})" > "$REVIEW_OUTPUT"
          echo "" >> "$REVIEW_OUTPUT"
          echo "*Automated review by Claude Code (plan-reviewer agent, model: ${MODEL})*" >> "$REVIEW_OUTPUT"
          echo "" >> "$REVIEW_OUTPUT"

          REVIEW_SUCCESS=true
          PLAN_NUM=0
          TOTAL_PLANS=$(echo "${{ needs.find-plans.outputs.plans }}" | grep -c '[^ ]' || echo 0)

          while IFS= read -r plan_file; do
            [ -z "$plan_file" ] && continue
            [ ! -f "$plan_file" ] && { echo "[$(date -u +%H:%M:%S)] SKIP: $plan_file (file not found)"; continue; }

            PLAN_NUM=$((PLAN_NUM + 1))
            FILE_SIZE=$(wc -c < "$plan_file")
            FILE_LINES=$(wc -l < "$plan_file")

            echo "::group::Review $PLAN_NUM/$TOTAL_PLANS: $plan_file ($MODEL)"
            echo "[$(date -u +%H:%M:%S)] START reviewing: $plan_file"
            echo "[$(date -u +%H:%M:%S)] File size: $FILE_LINES lines, $FILE_SIZE bytes"

            echo "---" >> "$REVIEW_OUTPUT"
            echo "" >> "$REVIEW_OUTPUT"
            echo "## Plan: $plan_file" >> "$REVIEW_OUTPUT"
            echo "" >> "$REVIEW_OUTPUT"

            # Build prompt file to avoid shell quoting issues
            PROMPT_FILE="/tmp/plan-prompt-${MODEL}.txt"
            {
              echo "You are a plan reviewer. Review the following implementation plan for a chess website project."
              echo "Evaluate: completeness, feasibility, risks, missing considerations, and suggested improvements."
              echo "Be concise - provide key findings in a structured format."
              echo ""
              echo "---"
              echo "File: $plan_file"
              echo ""
              cat "$plan_file"
              echo "---"
            } > "$PROMPT_FILE"

            PROMPT_SIZE=$(wc -c < "$PROMPT_FILE")
            echo "[$(date -u +%H:%M:%S)] Prompt size: $PROMPT_SIZE bytes"
            echo "[$(date -u +%H:%M:%S)] Running: timeout 300 claude -p --model $MODEL --max-turns 5 --output-format text (no agent)"

            START_TIME=$(date +%s)

            # Run Claude Code WITHOUT --agent to avoid codebase exploration (plan content is in the prompt)
            # --max-turns 5: allow enough turns for thorough plan review
            if timeout 300 bash -c "cat '$PROMPT_FILE' | claude -p --model '$MODEL' --max-turns 5 --output-format text" \
              >> "$REVIEW_OUTPUT" 2> "$ERROR_LOG"; then
              END_TIME=$(date +%s)
              DURATION=$((END_TIME - START_TIME))
              echo "[$(date -u +%H:%M:%S)] SUCCESS: $plan_file reviewed in ${DURATION}s"
            else
              EXIT_CODE=$?
              END_TIME=$(date +%s)
              DURATION=$((END_TIME - START_TIME))
              REVIEW_SUCCESS=false

              echo "[$(date -u +%H:%M:%S)] FAILED: exit code $EXIT_CODE after ${DURATION}s"

              # Log stderr
              if [ -s "$ERROR_LOG" ]; then
                echo "[$(date -u +%H:%M:%S)] Error log contents:"
                cat "$ERROR_LOG"
              else
                echo "[$(date -u +%H:%M:%S)] Error log is empty"
              fi

              echo "" >> "$REVIEW_OUTPUT"
              echo "**Review Failed**" >> "$REVIEW_OUTPUT"
              echo "" >> "$REVIEW_OUTPUT"

              if [ "$EXIT_CODE" = "124" ]; then
                echo "Claude Code timed out after 5 minutes." >> "$REVIEW_OUTPUT"
                echo "[$(date -u +%H:%M:%S)] TIMEOUT: Claude Code exceeded 5-minute limit"
              else
                ERROR_MSG=$(cat "$ERROR_LOG" 2>/dev/null || echo "No error log")
                echo "Claude Code encountered an error (exit code: $EXIT_CODE):" >> "$REVIEW_OUTPUT"
                echo "" >> "$REVIEW_OUTPUT"
                echo '```' >> "$REVIEW_OUTPUT"
                echo "$ERROR_MSG" >> "$REVIEW_OUTPUT"
                echo '```' >> "$REVIEW_OUTPUT"
              fi

              echo "" >> "$REVIEW_OUTPUT"
              echo "Please review this plan manually." >> "$REVIEW_OUTPUT"
            fi

            echo "" >> "$REVIEW_OUTPUT"
            echo "::endgroup::"
          done <<< "${{ needs.find-plans.outputs.plans }}"

          echo "[$(date -u +%H:%M:%S)] All reviews complete. Success: $REVIEW_SUCCESS"
          echo ""
          echo "::group::Review output"
          cat "$REVIEW_OUTPUT"
          echo "::endgroup::"

          if [ "$REVIEW_SUCCESS" = false ]; then
            exit 1
          fi

      - name: Post review comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const model = '${{ matrix.model }}';
            const reviewPath = `/tmp/plan-review-${model}.md`;

            let body;
            if (fs.existsSync(reviewPath)) {
              body = fs.readFileSync(reviewPath, 'utf8');
            } else {
              body = '# Claude Plan Review (' + model.toUpperCase() + ')\n\n**Review Unavailable**\n\nThe automated plan review could not be completed. Please review manually.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  review-plan-gemini:
    needs: find-plans
    if: needs.find-plans.outputs.has_plans == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: cd .github/scripts && npm install

      - name: Review plans with Gemini
        id: review
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-2.0-flash
          PLAN_FILES: ${{ needs.find-plans.outputs.plans }}
        run: node .github/scripts/review-plan-gemini.mjs

      - name: Post review comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviewPath = '/tmp/plan-review-gemini.md';

            let body;
            if (fs.existsSync(reviewPath)) {
              body = fs.readFileSync(reviewPath, 'utf8');
            } else {
              body = '# Gemini Plan Review\n\n**Review Unavailable**\n\nThe automated plan review could not be completed. Please review manually.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
