name: Plan Review

on:
  push:
    branches:
      - 'plan/**'
      - 'plan/*'
  pull_request:
    paths:
      - '**/*.plan.md'
      - '**/plan-*.md'
      - 'dev/active/**/plan.md'
      - 'dev/active/**/*-plan.md'

jobs:
  find-plans:
    runs-on: ubuntu-latest
    outputs:
      has_plans: ${{ steps.find-plans.outputs.has_plans }}
      plans: ${{ steps.find-plans.outputs.plans }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find plan files
        id: find-plans
        run: |
          # Find plan files that were changed
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(plan\.md|plan-.*\.md)$' || true)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(plan\.md|plan-.*\.md)$' || true)
          fi

          # Also check dev/active for plan files
          ACTIVE_PLANS=$(find dev/active -name "*plan*.md" 2>/dev/null | head -5 || true)

          # Combine and dedupe
          ALL_PLANS=$(echo -e "${CHANGED_FILES}\n${ACTIVE_PLANS}" | sort -u | grep -v '^$' | head -5)

          if [ -z "$ALL_PLANS" ]; then
            echo "No plan files found"
            echo "has_plans=false" >> $GITHUB_OUTPUT
          else
            echo "Found plans:"
            echo "$ALL_PLANS"
            echo "plans<<EOF" >> $GITHUB_OUTPUT
            echo "$ALL_PLANS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_plans=true" >> $GITHUB_OUTPUT
          fi

  review-plan-claude:
    needs: find-plans
    if: needs.find-plans.outputs.has_plans == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        model: [opus, sonnet]
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Review plans with Claude Code (${{ matrix.model }})
        id: review
        continue-on-error: true
        env:
          CLAUDE_CODE_USE_BEDROCK: '0'
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          MODEL="${{ matrix.model }}"
          REVIEW_OUTPUT="/tmp/plan-review-${MODEL}.md"
          ERROR_LOG="/tmp/claude-error.log"

          echo "# Claude Plan Review (${MODEL^^})" > "$REVIEW_OUTPUT"
          echo "" >> "$REVIEW_OUTPUT"
          echo "*Automated review by Claude Code (plan-reviewer agent, model: ${MODEL})*" >> "$REVIEW_OUTPUT"
          echo "" >> "$REVIEW_OUTPUT"

          REVIEW_SUCCESS=true

          while IFS= read -r plan_file; do
            [ -z "$plan_file" ] && continue
            [ ! -f "$plan_file" ] && continue

            echo "Reviewing with $MODEL: $plan_file"
            echo "---" >> "$REVIEW_OUTPUT"
            echo "" >> "$REVIEW_OUTPUT"
            echo "## Plan: $plan_file" >> "$REVIEW_OUTPUT"
            echo "" >> "$REVIEW_OUTPUT"

            # Build prompt file to avoid shell quoting issues
            PROMPT_FILE="/tmp/plan-prompt-${MODEL}.txt"
            {
              echo "Review the following implementation plan:"
              echo ""
              echo "---"
              echo "File: $plan_file"
              echo ""
              cat "$plan_file"
              echo "---"
            } > "$PROMPT_FILE"

            # Run Claude Code with 10-minute timeout and limited turns
            if timeout 600 bash -c "cat '$PROMPT_FILE' | claude -p --agent plan-reviewer --model '$MODEL' --max-turns 3 --output-format text" \
              >> "$REVIEW_OUTPUT" 2> "$ERROR_LOG"; then
              echo "Review completed for $plan_file ($MODEL)"
            else
              EXIT_CODE=$?
              REVIEW_SUCCESS=false
              ERROR_MSG=$(cat "$ERROR_LOG" 2>/dev/null || echo "No error log")

              echo "" >> "$REVIEW_OUTPUT"
              echo "**Review Failed**" >> "$REVIEW_OUTPUT"
              echo "" >> "$REVIEW_OUTPUT"

              if [ "$EXIT_CODE" = "124" ]; then
                echo "Claude Code timed out after 10 minutes." >> "$REVIEW_OUTPUT"
              else
                echo "Claude Code encountered an error:" >> "$REVIEW_OUTPUT"
                echo "" >> "$REVIEW_OUTPUT"
                echo '```' >> "$REVIEW_OUTPUT"
                echo "$ERROR_MSG" >> "$REVIEW_OUTPUT"
                echo '```' >> "$REVIEW_OUTPUT"
              fi

              echo "" >> "$REVIEW_OUTPUT"
              echo "Please review this plan manually." >> "$REVIEW_OUTPUT"
            fi

            echo "" >> "$REVIEW_OUTPUT"
          done <<< "${{ needs.find-plans.outputs.plans }}"

          echo "Review complete. Output:"
          cat "$REVIEW_OUTPUT"

          if [ "$REVIEW_SUCCESS" = false ]; then
            exit 1
          fi

      - name: Post review comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const model = '${{ matrix.model }}';
            const reviewPath = `/tmp/plan-review-${model}.md`;

            let body;
            if (fs.existsSync(reviewPath)) {
              body = fs.readFileSync(reviewPath, 'utf8');
            } else {
              body = '# Claude Plan Review (' + model.toUpperCase() + ')\n\n**Review Unavailable**\n\nThe automated plan review could not be completed. Please review manually.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  review-plan-gemini:
    needs: find-plans
    if: needs.find-plans.outputs.has_plans == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: cd .github/scripts && npm install

      - name: Review plans with Gemini
        id: review
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-2.0-flash
          PLAN_FILES: ${{ needs.find-plans.outputs.plans }}
        run: node .github/scripts/review-plan-gemini.mjs

      - name: Post review comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviewPath = '/tmp/plan-review-gemini.md';

            let body;
            if (fs.existsSync(reviewPath)) {
              body = fs.readFileSync(reviewPath, 'utf8');
            } else {
              body = '# Gemini Plan Review\n\n**Review Unavailable**\n\nThe automated plan review could not be completed. Please review manually.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
